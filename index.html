<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>VNG International GIS Map – Service Points in Salfit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 100vh; width: 100vw; margin: 0; padding: 0; }
    body { margin: 0; padding: 0; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // 1. إعداد الخريطة مع تركيز على مدينة سلفيت
    const map = L.map("map", {
      center: [32.0796, 35.1714], // إحداثيات سلفيت
      zoom: 15
    });

    // 2. طبقات الأساس
    const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map); // الطبقة الافتراضية

    const satellite = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
      attribution: "Tiles © Esri"
    });

    // 3. تحميل GeoJSON مع تصفية النقاط غير الصالحة
    fetch("PointCon.json")
      .then(res => res.json())
      .then(data => {
        const validFeatures = data.features.filter(f =>
          f.geometry &&
          f.geometry.type === "Point" &&
          Array.isArray(f.geometry.coordinates) &&
          f.geometry.coordinates.length === 2 &&
          typeof f.geometry.coordinates[0] === "number" &&
          typeof f.geometry.coordinates[1] === "number"
        );

        const cleanedData = { ...data, features: validFeatures };

        const geojsonLayer = L.geoJSON(cleanedData, {
          onEachFeature: function (feature, layer) {
            let popupContent = "<b>Details:</b><br>";
            for (let key in feature.properties) {
              popupContent += `${key}: ${feature.properties[key]}<br>`;
            }
            layer.bindPopup(popupContent);
          },
          pointToLayer: function (feature, latlng) {
            return L.circleMarker(latlng, {
              radius: 6,
              fillColor: "#ff7800",
              color: "#000",
              weight: 1,
              opacity: 1,
              fillOpacity: 0.8
            });
          }
        }).addTo(map);

        // 4. تحكم بالطبقات
        const baseMaps = {
          "OpenStreetMap": osm,
          "Satellite (Esri)": satellite
        };

        const overlayMaps = {
          "PointCon Layer": geojsonLayer
        };

        L.control.layers(baseMaps, overlayMaps, { collapsed: false }).addTo(map);
      })
      .catch(err => {
        alert("فشل تحميل ملف PointCon.json. تأكدي من وجوده بجانب هذا الملف.");
        console.error(err);
      });
  </script>
</body>
</html>
