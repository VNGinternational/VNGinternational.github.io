<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>VNG International GIS Map – Service Units in Salfeet</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; width: 100%; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    .nav-button {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: white;
      border: 1px solid #ccc;
      padding: 10px;
      cursor: pointer;
      z-index: 1000;
    }
    #left-button { left: 10px; }
    #right-button { right: 10px; }

    #searchBox {
      position: absolute;
      top: 10px;
      left: 50px;
      z-index: 1000;
      background: white;
      padding: 5px;
      border-radius: 5px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.65);
    }

    #basemapToggle {
      position: absolute;
      top: 10px;
      right: 50px;
      z-index: 1000;
      background: white;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 5px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.65);
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="left-button" class="nav-button"><i class="fas fa-arrow-left"></i></div>
  <div id="right-button" class="nav-button"><i class="fas fa-arrow-right"></i></div>
  <div id="searchBox">
    <input type="text" id="searchInput" placeholder="ابحث عن UNIT_ID" />
    <button onclick="searchUnit()">بحث</button>
  </div>
  <div id="basemapToggle">تبديل الخريطة</div>

  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

  <script>
    const map = L.map('map', {
      center: [32.0762, 35.1847],
      zoom: 18,
      zoomSnap: 0.5
    });

    const esriLayer = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles © Esri'
      }
    ).addTo(map);

    const osmLayer = L.tileLayer(
      'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 19
      }
    );

    let currentBase = "esri";
    document.getElementById("basemapToggle").onclick = function () {
      if (currentBase === "esri") {
        map.removeLayer(esriLayer);
        osmLayer.addTo(map);
        currentBase = "osm";
      } else {
        map.removeLayer(osmLayer);
        esriLayer.addTo(map);
        currentBase = "esri";
      }
    };

    const pointLayer = L.layerGroup().addTo(map);
    let geojsonLayer;

    $.getJSON("PointCon.json")
      .done(function (data) {
        geojsonLayer = L.geoJson(data, {
          pointToLayer: function (feature, latlng) {
            return L.circleMarker(latlng, {
              radius: 6,
              fillColor: "blue",
              color: "blue",
              weight: 1,
              opacity: 1,
              fillOpacity: 0.9
            });
          },
          onEachFeature: function (feature, layer) {
            const p = feature.properties;
            const popup = `
              <b>الاسم:</b> ${p.data_unit_ || "N/A"}<br>
              <b>رقم الوحدة:</b> ${p.UNIT_ID || "N/A"}<br>
              <b>رقم الكهرباء:</b> ${p.elec_numb || "N/A"}<br>
              <b>رقم المياه:</b> ${p.Water_numb || "N/A"}<br>
              <b>تصريح البناء:</b> ${p.bod_permit || "N/A"}<br>
              <b>رخصة الحرف:</b> ${p.crafts_lic || "N/A"}<br>
              <b>ضريبة المعارف:</b> ${p.Edu_tax || "N/A"}<br>
              <b>تصريح مخصص:</b> ${p.Permit_cus || "N/A"}<br>
              <b>GDPT:</b> ${p.GDPT || "N/A"}
            `;
            layer.bindPopup(popup);
          }
        });
        geojsonLayer.addTo(pointLayer);
        map.fitBounds(geojsonLayer.getBounds());
      })
      .fail(function () {
        alert("❌ فشل تحميل ملف PointCon.json – تأكد من الاسم أو المسار.");
      });

    function searchUnit() {
      const id = document.getElementById("searchInput").value.trim();
      if (!id || !geojsonLayer) return;

      let found = false;
      geojsonLayer.eachLayer(function (layer) {
        const p = layer.feature.properties;
        if (p.UNIT_ID && p.UNIT_ID.toString() === id) {
          map.setView(layer.getLatLng(), 20);
          layer.openPopup();
          found = true;
        }
      });

      if (!found) {
        alert("الوحدة غير موجودة.");
      }
    }

    L.control.locate({
      position: 'topleft',
      drawCircle: false,
      follow: true,
      setView: true,
      markerStyle: { weight: 1, opacity: 0.8, fillOpacity: 0.8 },
      icon: 'fa fa-location-arrow',
      metric: true,
      locateOptions: {
        maxZoom: 20,
        enableHighAccuracy: true,
        timeout: 10000
      }
    }).addTo(map);

    document.getElementById('left-button').addEventListener('click', () => {
      const c = map.getCenter();
      map.panTo([c.lat, c.lng - 0.005]);
    });

    document.getElementById('right-button').addEventListener('click', () => {
      const c = map.getCenter();
      map.panTo([c.lat, c.lng + 0.005]);
    });
  </script>
</body>
</html>
