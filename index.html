<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>VNG International GIS Map – Service Units in Salfeet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 100vh; width: 100vw; margin: 0; padding: 0; }
    body { margin: 0; padding: 0; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map("map", {
      center: [32.0796, 35.1714],
      zoom: 15
    });

    // طبقات الأساس
    const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const satellite = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
      attribution: "Tiles © Esri"
    });

    // دالة لتحميل GeoJSON مع إعدادات خاصة
    function loadGeoJSON(url, style, layerName, isPoint = false) {
      fetch(url)
        .then(res => res.json())
        .then(data => {
          let filteredData = data;

          if (isPoint) {
            filteredData = {
              ...data,
              features: data.features.filter(f =>
                f.geometry &&
                f.geometry.type === "Point" &&
                Array.isArray(f.geometry.coordinates) &&
                typeof f.geometry.coordinates[0] === "number" &&
                typeof f.geometry.coordinates[1] === "number"
              )
            };
          }

          const layer = L.geoJSON(filteredData, {
            style: style,
            onEachFeature: function (feature, layer) {
              let popup = `<b>${layerName}</b><br>`;
              for (let key in feature.properties) {
                popup += `${key}: ${feature.properties[key]}<br>`;
              }
              layer.bindPopup(popup);
            },
            pointToLayer: function (feature, latlng) {
              return L.circleMarker(latlng, {
                radius: 6,
                fillColor: style.color || "#3388ff",
                color: "#000",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
              });
            }
          }).addTo(map);

          overlayLayers[layerName] = layer;
          layerControl.addOverlay(layer, layerName);
        })
        .catch(err => console.error(`❌ فشل تحميل ${url}`, err));
    }

    // تحكم بالطبقات
    const overlayLayers = {};
    const baseLayers = {
      "OpenStreetMap": osm,
      "Satellite (Esri)": satellite
    };
    const layerControl = L.control.layers(baseLayers, overlayLayers, { collapsed: false }).addTo(map);

    // تحميل الطبقات بالألوان المحددة
    loadGeoJSON("PointCon.json", { color: "#ff7800" }, "Service Points", true);
    loadGeoJSON("Building.json", { color: "#8B4513", weight: 1, fillOpacity: 0.4 }, "Buildings"); // بني
    loadGeoJSON("Parcel.json", { color: "#FF0000", weight: 2, fillOpacity: 0.0 }, "Parcels");     // أحمر
    loadGeoJSON("Block.json", { color: "#000000", weight: 2, fillOpacity: 0.0 }, "Blocks");       // أسود

  </script>
</body>
</html>
